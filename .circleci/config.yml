version: 2.1
jobs:
  dockers:
    executor: node-docker
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install Docker Compose
          command: |
            apk update && apk upgrade && apk add curl  
            curl -L "https://github.com/docker/compose/releases/download/v2.5.0/docker-compose-linux-x86_64" -o ~/docker-compose  
            chmod +x ~/docker-compose  
            mv ~/docker-compose /usr/local/bin/docker-compose
      - run:
          name: Run tests and push Docker image
          command: |
            docker-compose build
            docker login -u rwigara -p $DOCKERHUB_PASSWORD
            docker tag rwigara/e-commerce-lydia-32-bn-backend:latest rwigara/e-commerce-lydia-32-bn-backend:latest
            docker push rwigara/e-commerce-lydia-32-bn-backend:latest

  store_test_results:
    docker:
      - image: cimg/node:21.7.2-browsers

    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: npm install
      - store_test_results:
          path: ~/project/test-results
          destination: test-results
  deploy:
    docker:
      - image: cimg/node:21.7.1
    steps:
      - checkout
      - run:
          name: Deploy to Render
          command: |
            curl -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${RENDER_API_KEY}" -d '{"branch":"develop"}' https://api.render.com/deploy/srv-cp0dvfg21fec738323g0?key=${RENDER_DEPLOY_HOOK}
workflows:
  build_and_test:
    jobs:
      - dockers
      - store_test_results:
          requires:
            - dockers
      - deploy:
          requires:
            - dockers